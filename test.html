<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClickNest SDK Test Page</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 600px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; }
    h1 { margin-bottom: 8px; }
    p.subtitle { color: #666; margin-bottom: 32px; }
    .card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 16px; }
    .card h2 { font-size: 16px; margin-bottom: 12px; }
    button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-danger { background: #dc2626; color: white; }
    input, select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; margin: 4px; }
    form { display: flex; flex-direction: column; gap: 8px; }
    #log { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-top: 24px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
    #status { padding: 8px 12px; border-radius: 6px; margin-bottom: 24px; font-size: 13px; }
    #status.ok { background: #dcfce7; color: #166534; }
    #status.err { background: #fee2e2; color: #991b1b; }
    #status.loading { background: #f3f4f6; color: #6b7280; }
    nav { display: flex; gap: 8px; margin-bottom: 24px; }
    nav a { color: #2563eb; text-decoration: none; padding: 4px 8px; border-radius: 4px; }
    nav a:hover { background: #eff6ff; }
  </style>
</head>
<body>
  <h1>ClickNest Test Page</h1>
  <p class="subtitle">Interact with elements below to generate analytics events</p>

  <div id="status" class="loading">Connecting to ClickNest...</div>

  <nav>
    <a href="#home">Home</a>
    <a href="#products">Products</a>
    <a href="#checkout">Checkout</a>
    <a href="#account">Account</a>
  </nav>

  <div class="card">
    <h2>Actions</h2>
    <button id="add-to-cart" class="btn-primary" aria-label="Add to cart">Add to Cart</button>
    <button id="checkout-submit" class="btn-primary" aria-label="Submit checkout form">Place Order</button>
    <button id="save-settings" class="btn-secondary">Save Settings</button>
    <button id="delete-account" class="btn-danger" data-action="destructive">Delete Account</button>
  </div>

  <div class="card">
    <h2>Form Test</h2>
    <form id="signup-form" aria-label="Sign up form">
      <input type="text" id="username" placeholder="Username" aria-label="Username" />
      <input type="email" id="email" placeholder="Email" aria-label="Email address" />
      <select id="plan" aria-label="Select plan">
        <option value="free">Free</option>
        <option value="pro">Pro</option>
        <option value="enterprise">Enterprise</option>
      </select>
      <button type="submit" class="btn-primary" id="signup-btn">Sign Up</button>
    </form>
  </div>

  <div id="log">Waiting for events...</div>

  <script>
    const HOST = window.location.origin;
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    function logEvent(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
    }

    // Fetch the API key from the server, then load the SDK dynamically.
    async function init() {
      try {
        const resp = await fetch(`${HOST}/api/v1/project`);
        if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
        const project = await resp.json();

        statusEl.className = 'ok';
        statusEl.textContent = `Connected to "${project.name}" â€” API key: ${project.api_key}`;

        // Load SDK dynamically with the real API key.
        const script = document.createElement('script');
        script.src = `${HOST}/sdk.js`;
        script.dataset.apiKey = project.api_key;
        script.dataset.host = HOST;
        document.head.appendChild(script);

        logEvent('SDK loaded, autocapture active. Click around!');
      } catch (e) {
        statusEl.className = 'err';
        statusEl.textContent = `Failed to connect: ${e.message}. Is the server running on ${HOST}?`;
      }
    }

    init();

    // Log captured events to the debug panel.
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') {
        logEvent(`click: <${e.target.tagName.toLowerCase()}> "${e.target.textContent.trim()}" #${e.target.id}`);
      }
    });

    document.getElementById('signup-form').addEventListener('submit', (e) => {
      e.preventDefault();
      logEvent('submit: signup-form');
    });
  </script>
</body>
</html>
